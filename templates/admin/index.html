{% extends "base.html" %} {% block title %}Admin Portal - Course Tracker{%
endblock %} {% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/components.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/theme-student.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/admin_dashboard.css') }}"
/>
{% endblock %} {% block content %}
<div class="dashboard-header">
  <h1>Admin Portal</h1>
  <p>
    Administrative hub for enrollment management, salary reporting, and grade
    analysis.
  </p>
</div>

<div class="dashboard">
  <!-- Salary Report Card -->
  <div class="portal-card">
    <h3>Salary Report</h3>
    <p>
      Employee salary analysis with subqueries and stored functions for
      department averages.
    </p>
    <a href="{{ url_for('admin.salary_report') }}" class="btn btn-primary"
      >View Report</a
    >
  </div>

  <!-- Grade Analytics Card -->
  <div class="portal-card">
    <h3>Grade Analytics</h3>
    <p>
      Course and professor performance analysis using aggregation and both
      database views (current enrollments & completed courses).
    </p>
    <a href="{{ url_for('admin.analytics') }}" class="btn btn-primary"
      >View Analytics</a
    >
  </div>
</div>

<!-- Current Enrollments Section -->
<div class="content-card" style="margin-top: 2rem">
  <h2>All Current Enrollments</h2>
  <p class="section-hint">Click on a row to edit the enrollment.</p>

  {% if current_enrollments and current_enrollments|length > 0 %}
  <table class="data-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Student</th>
        <th>Course Title</th>
        <th>Course Code</th>
        <th>Professor</th>
        <th>Credits</th>
        <th>Grade</th>
      </tr>
    </thead>
    <tbody>
      {% for enrollment in current_enrollments %}
      <tr class="clickable-row" data-popup-index="{{ loop.index0 }}">
        <td>
          <span class="id-badge">{{ enrollment.studentId }}</span>
        </td>
        <td class="cell-title">{{ enrollment.studentName }}</td>
        <td>{{ enrollment.title }}</td>
        <td>
          <span class="id-badge">
            {% if enrollment.code and ',' in enrollment.code %} ({{
            enrollment.code }}) {%- else -%} {{ enrollment.code or
            enrollment.courseId }} {%- endif -%} :{{ enrollment.sectionNo }}
          </span>
        </td>
        <td class="cell-muted">{{ enrollment.professor or 'TBA' }}</td>
        <td>
          <span class="credits-badge">{{ enrollment.credits }} credits</span>
        </td>
        <td>
          <span
            class="grade-badge {% if enrollment.grade %}grade-{{ enrollment.grade[0]|lower }}{% else %}grade-none{% endif %}"
          >
            {{ enrollment.grade or '--' }}
          </span>
        </td>
      </tr>
      <!-- Hidden popup menu for this row -->
      <div
        class="enrollment-popup"
        id="popup-{{ loop.index0 }}"
        style="display: none"
      >
        <div class="popup-header">
          <strong>{{ enrollment.studentName }}</strong> - {{ enrollment.title }}
          <button class="popup-close" data-popup-index="{{ loop.index0 }}">
            &times;
          </button>
        </div>
        <div class="popup-content">
          <form
            method="POST"
            action="{{ url_for('admin.update_grade', student_id=enrollment.studentId, course_id=enrollment.courseId, section_no=enrollment.sectionNo) }}"
            class="popup-form"
          >
            <label>Set Grade:</label>
            <div class="popup-form-row">
              <select name="grade" class="grade-select">
                <option
                  value=""
                  {%
                  if
                  not
                  enrollment.grade
                  %}selected{%
                  endif
                  %}
                >
                  --
                </option>
                {% for g in grades %}
                <option
                  value="{{ g }}"
                  {% if enrollment.grade == g %}selected{% endif %}
                >
                  {{ g }}
                </option>
                {% endfor %}
              </select>
              <button type="submit" class="btn-save">Save</button>
            </div>
          </form>
          <hr />
          <form
            method="POST"
            action="{{ url_for('admin.drop_enrollment', student_id=enrollment.studentId, course_id=enrollment.courseId, section_no=enrollment.sectionNo) }}"
          >
            <button
              type="submit"
              class="btn-drop"
              onclick="return confirm('Are you sure you want to drop {{ enrollment.studentName }} from {{ enrollment.title }}?')"
            >
              Drop Course
            </button>
          </form>
        </div>
      </div>
      {% endfor %}
    </tbody>
  </table>
  <!-- Popup overlay -->
  <div class="popup-overlay" id="popup-overlay"></div>
  <div class="info-box">
    <h4>Database View</h4>
    <p>
      This table is populated using the
      <code>current_student_enrollments</code> database view, which joins
      <code>Student</code>, <code>enrolls_in</code>, <code>Section</code>, and
      <code>Course</code> tables to display all active student enrollments with
      course and instructor details.
    </p>
  </div>
  {% else %}
  <div class="empty-state">
    <h3>No Current Enrollments</h3>
    <p>There are no students currently enrolled in any courses.</p>
  </div>
  {% endif %}
</div>
{% endblock %} {% block extra_js %}
<script src="{{ url_for('static', filename='js/enrollment-popup.js') }}"></script>
{% endblock %}
