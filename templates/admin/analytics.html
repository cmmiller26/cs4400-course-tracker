{% extends "base.html" %}
{% block title %}Grade Analytics - Admin Portal{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/theme-admin.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/analytics.css') }}">
{% endblock %}
{% block content %}
<div class="page-header">
  <h1>Course Grade Analytics</h1>
  <p>Performance analysis using aggregation and database views</p>
  <span class="sql-badge">QUERY: AGGREGATION, CASE & JOIN</span>
  <span class="sql-badge">VIEW</span>
</div>

<!-- Section 1: Average Grade by Course -->
<div class="section-header">
  <h2>Average Grade by Course</h2>
</div>

<div class="query-description">
  <h3>SQL Concepts Used</h3>
  <p>This analysis demonstrates the following SQL concepts:</p>
  <ul>
    <li>
      <strong>AGGREGATION:</strong> The <code>AVG()</code> and <code>COUNT()</code> functions are used with
      <code>GROUP BY courseId</code> to calculate the average grade and total number of graded students for each course.
    </li>
    <li>
      <strong>CASE Statement:</strong> Converts letter grades (e.g., 'A', 'B-') into numeric grade points (e.g., 4.0,
      2.67) within the <code>AVG()</code> function to enable mathematical calculation.
    </li>
    <li>
      <strong>JOIN:</strong> The <code>Course</code> table is joined with the <code>enrolls_in</code> table to link
      grades to course titles.
    </li>
  </ul>
</div>

{% if course_grades %}
<div class="result-count">
  <strong>{{ course_grades|length }}</strong> courses analyzed
</div>

<table class="data-table">
  <thead>
    <tr>
      <th>Course ID</th>
      <th>Course Title</th>
      <th>Average Grade</th>
      <th>Students Graded</th>
    </tr>
  </thead>
  <tbody>
    {% for course in course_grades %}
    <tr>
      <td><span class="id-badge">{{ course.courseId }}</span></td>
      <td class="cell-title">{{ course.title }}</td>
      <td>
        {% set avg = course.avg_grade|float %}
        <span class="grade-badge {% if avg >= 3.7 %}grade-a{% elif avg >= 2.7 %}grade-b{% elif avg >= 1.7 %}grade-c{% elif avg >= 0.7 %}grade-d{% else %}grade-f{% endif %}">
          {{ "%.2f"|format(avg) }}
        </span>
      </td>
      <td>
        <span class="stats-badge">{{ course.student_count }} students</span>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<div class="empty-state">
  <h3>No Course Grade Data Available</h3>
  <p>No completed courses with grades found.</p>
</div>
{% endif %}

<!-- Section 2: Average Grade by Professor -->
<div class="section-header">
  <h2>Average Grade by Professor</h2>
</div>

<div class="query-description">
  <h3>SQL Concepts Used</h3>
  <p>This analysis demonstrates a more complex query involving multiple tables:</p>
  <ul>
    <li>
      <strong>Multi-Table JOIN:</strong> Combines data from <code>Professor</code>, <code>Employee</code>,
      <code>teaches</code>, and <code>enrolls_in</code> to link professors to the grades given in the courses they
      teach.
    </li>
    <li>
      <strong>AGGREGATION:</strong> Uses <code>AVG()</code> to calculate the average grade and
      <code>COUNT(DISTINCT)</code> to count unique students and courses, all grouped by professor.
    </li>
  </ul>
</div>

{% if professor_grades %}
<div class="result-count">
  <strong>{{ professor_grades|length }}</strong> professors analyzed
</div>

<table class="data-table">
  <thead>
    <tr>
      <th>Employee ID</th>
      <th>Professor Name</th>
      <th>Average Grade</th>
      <th>Students Taught</th>
      <th>Courses Taught</th>
    </tr>
  </thead>
  <tbody>
    {% for prof in professor_grades %}
    <tr>
      <td><span class="id-badge">{{ prof.employeeId }}</span></td>
      <td class="cell-title">{{ prof.name }}</td>
      <td>
        {% set avg = prof.avg_grade|float %}
        <span class="grade-badge {% if avg >= 3.7 %}grade-a{% elif avg >= 2.7 %}grade-b{% elif avg >= 1.7 %}grade-c{% elif avg >= 0.7 %}grade-d{% else %}grade-f{% endif %}">
          {{ "%.2f"|format(avg) }}
        </span>
      </td>
      <td>
        <span class="stats-badge stats-badge-students">{{ prof.student_count }} students</span>
      </td>
      <td>
        <span class="stats-badge stats-badge-courses">{{ prof.courses_taught }} courses</span>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<div class="empty-state">
  <h3>No Professor Grade Data Available</h3>
  <p>No professors with completed courses found.</p>
</div>
{% endif %}

<!-- Section 3: Completed Courses View -->
<div class="section-header">
  <h2>Completed Student Courses</h2>
</div>

<div class="query-description">
  <h3>SQL Concept Used</h3>
  <p>This table demonstrates the use of a pre-defined database view:</p>
  <ul>
    <li>
      <strong>DATABASE VIEW:</strong> The data is selected directly from the <code>completed_student_courses</code>
      view. This view encapsulates the complexity of joining multiple tables and filtering for completed courses,
      simplifying the application query to a simple <code>SELECT * FROM completed_student_courses</code>.
    </li>
  </ul>
</div>

{% if completed_courses %}
<div class="result-count">
  <strong>{{ completed_courses|length }}</strong> completed course records
</div>

<table class="data-table">
  <thead>
    <tr>
      <th>Student ID</th>
      <th>Student Name</th>
      <th>Course Title</th>
      <th>Section</th>
      <th>Grade</th>
      <th>Completion Date</th>
    </tr>
  </thead>
  <tbody>
    {% for course in completed_courses %}
    <tr>
      <td><span class="id-badge">{{ course.studentId }}</span></td>
      <td class="cell-title">{{ course.studentName }}</td>
      <td>{{ course.title }}</td>
      <td>{{ course.sectionNo }}</td>
      <td>
        <span class="grade-badge grade-{{ course.grade[0]|lower }}">{{ course.grade }}</span>
      </td>
      <td>{{ course.enrolledDate }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<div class="empty-state">
  <h3>No Completed Courses</h3>
  <p>No students have completed courses yet.</p>
</div>
{% endif %}

{% endblock %}