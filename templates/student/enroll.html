{% extends "base.html" %}
{% block title %}Enroll in Course - Course Tracker{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/theme-student.css') }}">
{% endblock %}
{% block content %}
<div class="page-header">
  <h1>Enroll in Course Section</h1>
  <p>Demonstrates triggers, stored procedures, and data validation</p>
  <span class="sql-badge">QUERY: INSERT</span>
  <span class="sql-badge">3 TRIGGERS</span>
  <span class="sql-badge">STORED PROCEDURE</span>
</div>

<div class="query-description">
  <h3>Query Description</h3>
  <p>This enrollment process demonstrates multiple database concepts:</p>
  <ul>
    <li><strong>INSERT</strong> statement to add enrollment records</li>
    <li>
      <strong>3 Triggers</strong> that fire on INSERT to validate business
      rules
    </li>
    <li>
      <strong>Stored Procedure</strong>
      <code>update_open_seats(courseId, sectionNo)</code> to manage capacity
    </li>
  </ul>
</div>

<div class="trigger-box">
  <h3>Database Triggers in Action</h3>
  <p style="margin-bottom: 1rem">
    This form demonstrates <strong>3 database triggers</strong> that
    automatically enforce business rules:
  </p>
  <ul class="trigger-list">
    <li>
      <strong>1. prereq_check:</strong> Validates that all prerequisite
      courses have been completed with passing grades before allowing
      enrollment
    </li>
    <li>
      <strong>2. section_capacity_check:</strong> Prevents enrollment when the
      section has reached maximum capacity
    </li>
    <li>
      <strong>3. student_enrollment_status_check:</strong> Blocks duplicate
      enrollments and re-enrollment in courses that have already been completed
    </li>
  </ul>
  <div class="tip-box">
    <strong>Demo Tip:</strong> Try enrolling in different courses to see
    these triggers validate your enrollment! The system will automatically
    check prerequisites, capacity, and completion status.
  </div>
</div>

<form method="POST" class="enrollment-form">
  <div class="form-group">
    <label for="course_id">Select Course:</label>
    <select name="course_id" id="course_id" required onchange="filterSections()">
      <option value="">-- Choose a course --</option>
      {% for course in courses %}
      <option value="{{ course.courseId }}">
        {{ course.courseId }} - {{ course.title }} ({{ course.credits }}
        credits)
      </option>
      {% endfor %}
    </select>
    <small>Select the course you want to enroll in</small>
  </div>

  <div class="form-group">
    <label for="section_no">Select Section:</label>
    <select name="section_no" id="section_no" required>
      <option value="">-- First select a course --</option>
      {% for section in sections %}
      <option value="{{ section.sectionNo }}" data-course="{{ section.courseId }}"
        data-capacity="{{ section.capacity }}" data-title="{{ section.title }}" style="display: none">
        Section {{ section.sectionNo }} - {{ section.title }} (Capacity: {{
        section.capacity }} students)
      </option>
      {% endfor %}
    </select>
    <small>Choose a section (capacity will be validated by triggers)</small>
  </div>

  <div style="display: flex; gap: 1rem; margin-top: 2rem">
    <button type="submit" class="btn-submit" style="flex: 1;">Enroll in Course</button>
    <a href="{{ url_for('student.courses') }}" class="btn-cancel" style="flex: 1;">
      Cancel
    </a>
  </div>
</form>

<div class="how-it-works">
  <h4>How It Works</h4>
  <ol>
    <li>
      An INSERT statement adds the enrollment record to the
      <code>enrolls_in</code> table
    </li>
    <li>
      Three triggers fire automatically to validate prerequisites, capacity,
      and completion status
    </li>
    <li>
      If any validation fails, the enrollment is rejected with a descriptive
      error message
    </li>
    <li>
      The <code>update_open_seats</code> stored procedure is called to update
      available capacity
    </li>
  </ol>
</div>

<script>
  // Store all sections data on page load
  let allSectionsData = [];

  document.addEventListener("DOMContentLoaded", function () {
    // Capture all section options before any filtering
    const sectionOptions = document.querySelectorAll(
      "#section_no option[data-course]",
    );
    sectionOptions.forEach((option) => {
      allSectionsData.push({
        value: option.value,
        courseId: option.dataset.course,
        capacity: option.dataset.capacity,
        title: option.dataset.title,
        text: option.textContent,
      });
    });
  });

  function filterSections() {
    const courseSelect = document.getElementById("course_id");
    const sectionSelect = document.getElementById("section_no");
    const selectedCourse = courseSelect.value;

    // Reset section dropdown
    sectionSelect.innerHTML =
      '<option value="">-- Select a section --</option>';

    if (!selectedCourse) {
      return;
    }

    // Filter sections from stored data
    let sectionsAdded = 0;
    allSectionsData.forEach((sectionData) => {
      if (sectionData.courseId === selectedCourse) {
        const newOption = document.createElement("option");
        newOption.value = sectionData.value;
        newOption.textContent = sectionData.text;
        newOption.dataset.course = sectionData.courseId;
        newOption.dataset.capacity = sectionData.capacity;
        sectionSelect.appendChild(newOption);
        sectionsAdded++;
      }
    });

    if (sectionsAdded === 0) {
      sectionSelect.innerHTML =
        '<option value="">-- No sections available for this course --</option>';
    }
  }
</script>
{% endblock %}
